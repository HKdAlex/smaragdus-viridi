# Gemstone CRUD Inventory

This inventory captures every gemstone-related field across the Supabase schema and documents whether current admin tooling covers Create, Read, Update, and Delete flows. Legend: ✅ = covered, ⚠️ = partial/manual, ❌ = missing, n/a = system-managed.

## `public.gemstones`

| Field                                                                                                                                                                       | Type                   | Create UI              | Update Logic                                                                  | Notes                                                                                              |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ---------------------- | ----------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| `id`                                                                                                                                                                        | uuid                   | n/a                    | n/a                                                                           | Generated by Supabase. Exposed in detail views only.                                               |
| `serial_number`                                                                                                                                                             | text                   | ✅ `GemstoneForm`      | ✅ form + `validateGemstoneData` uniqueness check / `checkSerialNumberExists` | Required for insert; delete flow does not cascade to related tables (images, AI) today.            |
| `name`                                                                                                                                                                      | enum `gemstone_type`   | ✅                     | ✅ (updates mirror create)                                                    | `type_code` auto-derives from name when omitted.                                                   |
| `type_code`                                                                                                                                                                 | text                   | ⚠️ auto-set (`name`)   | ⚠️ auto-backfilled if name changes                                            | No UI to override type code explicitly.                                                            |
| `color` / `cut` / `clarity`                                                                                                                                                 | enum                   | ✅ selectors           | ✅ `GemstoneForm` / update + enum validation                                  | Codes (`*_code`) also auto-derived if missing.                                                     |
| `color_code` / `cut_code` / `clarity_code`                                                                                                                                  | text                   | ⚠️ computed            | ⚠️ computed                                                                   | No direct UI. Auto-updated by service when high-level field changes.                               |
| `weight_carats`                                                                                                                                                             | numeric                | ✅                     | ✅                                                                            | Only raw carat weight capturable. No UI for AI weight overrides.                                   |
| `length_mm` / `width_mm` / `depth_mm`                                                                                                                                       | numeric                | ✅                     | ✅                                                                            | Stored as numbers; no validation beyond >0.                                                        |
| `origin_id`                                                                                                                                                                 | uuid                   | ✅ select              | ✅                                                                            | Origins fetched directly inside client component via Supabase anon client.                         |
| `price_amount` / `price_currency`                                                                                                                                           | integer (cents) / enum | ✅                     | ✅ (`GemstoneForm`, `BulkEditModal`, `PriceManagementService`)                | Multiple pathways adjusting same fields; no concurrency safeguards.                                |
| `premium_price_amount` / `premium_price_currency`                                                                                                                           | integer / enum         | ✅ optional            | ✅                                                                            | UI allows empty but cannot clear currency independently.                                           |
| `price_per_carat`                                                                                                                                                           | numeric                | ❌                     | ❌                                                                            | Not computed anywhere; remains `null` in catalog.                                                  |
| `quantity`                                                                                                                                                                  | integer                | ❌                     | ❌                                                                            | No UI input or service update; relies on DB default (needs confirmation).                          |
| `in_stock`                                                                                                                                                                  | boolean                | ✅ toggle              | ✅ (`GemstoneForm`, `BulkEditModal`, `InventoryManagementService`)            | Archive/unarchive flows map to this flag.                                                          |
| `delivery_days`                                                                                                                                                             | integer                | ✅ optional            | ✅                                                                            | Accepts raw number; no bounds beyond placeholder guidance.                                         |
| `internal_code`                                                                                                                                                             | text                   | ✅ optional            | ✅                                                                            | Bulk edit supported.                                                                               |
| `description`                                                                                                                                                               | text                   | ✅                     | ✅                                                                            | Stored on `gemstones`; AI descriptions separate.                                                   |
| `promotional_text`                                                                                                                                                          | text                   | ✅                     | ✅                                                                            | Bulk edit supported.                                                                               |
| `marketing_highlights`                                                                                                                                                      | text[]                 | ✅ (manual list)       | ✅                                                                            | Stored on `gemstones`; AI highlights stored separately.                                            |
| `metadata_status`                                                                                                                                                           | enum                   | ❌                     | ❌                                                                            | No UI or service coverage; remains whatever backend defaults.                                      |
| `ai_text_generated_v6` / `_date`                                                                                                                                            | boolean / timestamptz  | ❌                     | ❌                                                                            | Only mutated via legacy migrations; no admin control.                                              |
| `ai_confidence_score` et al (`ai_*` columns on `gemstones`)                                                                                                                 | numeric/text           | ❌                     | ❌                                                                            | Legacy AI telemetry kept in table but never surfaced or updated by admin tooling.                  |
| `ai_analysis_v5` / `_date`                                                                                                                                                  | boolean / timestamptz  | ❌                     | ❌                                                                            | Vestigial flags; purely read data.                                                                 |
| `ai_color`, `ai_cut`, `ai_clarity`, `ai_weight_carats`, `ai_length_mm`, `ai_width_mm`, `ai_depth_mm`                                                                        | text/numeric           | ❌                     | ❌                                                                            | No UI; values only populated by backend processes.                                                 |
| `ai_description_cost_usd`, `ai_description_model`, `ai_extracted_date`, `ai_extraction_confidence`, `ai_quality_grade`, `ai_origin`, `ai_treatment`, `ai_data_completeness` | numeric/text           | ❌                     | ❌                                                                            | Observability-only fields.                                                                         |
| `primary_image_url` / `primary_video_url`                                                                                                                                   | text                   | n/a                    | ⚠️ managed indirectly                                                         | Trigger updates work when media flagged as primary; UI allows toggling primary but no direct edit. |
| `import_batch_id` / `import_folder_path` / `import_notes`                                                                                                                   | text                   | ⚠️ (`BulkImport` only) | ❌                                                                            | No admin UI to view or update after import.                                                        |
| `search_vector_*`, `description_vector_*`                                                                                                                                   | tsvector               | n/a                    | n/a                                                                           | Maintained via database triggers.                                                                  |
| `created_at` / `updated_at`                                                                                                                                                 | timestamptz            | n/a                    | ⚠️ `updated_at` manually set client-side                                      | Manual timestamps risk drift with client clock.                                                    |
| `metadata_status`, `ai_data_completeness`, `needs_review`                                                                                                                   | enum/bool              | ❌                     | ❌                                                                            | Critical moderation flags missing from UI and services.                                            |

## `public.gemstones_ai_v6`

| Field                                                                                                      | Type              | Create UI                | Update Logic                    | Notes                                                                                        |
| ---------------------------------------------------------------------------------------------------------- | ----------------- | ------------------------ | ------------------------------- | -------------------------------------------------------------------------------------------- |
| `technical_description_en` / `_ru`                                                                         | text              | ✅ (GemstoneForm AI tab) | ✅ (mapped via `ai_v6` payload) | Submitted only when admin populates fields; otherwise untouched.                             |
| `emotional_description_en` / `_ru`                                                                         | text              | ✅                       | ✅                              | Same as above.                                                                               |
| `narrative_story_en` / `_ru`                                                                               | text              | ✅                       | ✅                              | UI supports basic text entry; no validation for length.                                      |
| `promotional_text` / `_ru`                                                                                 | text              | ✅                       | ✅                              | Data stored in AI table; UI also writes `promotional_text` on base table for legacy content. |
| `marketing_highlights` / `_ru`                                                                             | text[]            | ✅                       | ✅                              | Managed via chip inputs per language.                                                        |
| `care_instructions_*`, `historical_context_*`                                                              | text              | ❌                       | ❌                              | No inputs to create/update; fields remain null.                                              |
| `primary_image_selection_reasoning`, `image_quality_scores`, `image_urls`, `used_images`                   | json/bool         | ❌                       | ❌                              | Not surfaced; relies on AI pipeline only.                                                    |
| `selected_image_uuid`, `recommended_primary_image_index`                                                   | text / int        | ❌                       | ❌                              | No UI to review or override AI choices.                                                      |
| `color_detection_confidence`, `cut_detection_confidence`, `color_matches_metadata`, `cut_matches_metadata` | numeric/bool      | ❌                       | ❌                              | Diagnostics only.                                                                            |
| `confidence_score`, `needs_review`, `review_notes`                                                         | numeric/bool/text | ❌                       | ❌                              | No moderation UI; admins cannot mark AI content reviewed.                                    |
| `generation_cost_usd`, `generation_time_ms`, `model_version`                                               | numeric/text      | ❌                       | ❌                              | Telemetry only; read in reports but not accessible.                                          |
| `created_at` / `updated_at`                                                                                | timestamptz       | n/a                      | ⚠️ set via service              | `GemstoneAdminService.updateGemstone` stamps `updated_at` new Date client-side.              |

## `public.gemstone_images` & `public.gemstone_videos`

| Field                                                                                 | Type          | Create UI                  | Update Logic               | Notes                                                                                                                              |
| ------------------------------------------------------------------------------------- | ------------- | -------------------------- | -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `image_url` / `video_url`                                                             | text          | ✅ (`EnhancedMediaUpload`) | ✅ via upload service      | Upload pipeline uses service-role client inside browser – security issue.                                                          |
| `is_primary` / `video_order`                                                          | boolean / int | ⚠️ toggle                  | ✅ `setPrimary*` endpoints | UI allows marking primary, but no reorder beyond primary vs others.                                                                |
| `image_order`                                                                         | int           | ❌                         | ❌                         | Stored as sequential insert order; no UI to reorder.                                                                               |
| `alt_text`, `original_filename`, `original_path`, `has_watermark`, `duration_seconds` | text/bool/int | ❌                         | ❌                         | Metadata captured from upload only; no edit UI.                                                                                    |
| Delete handling                                                                       | —             | ✅                         | ✅ / ⚠️                    | Delete removes storage object via admin client, but gemstone delete does **not** cascade; orphaned media risk if gemstone removed. |

## `public.certifications`

No admin CRUD coverage. Certifications appear in public detail view but there is no admin UI, service, or API route to create/update/delete certification records tied to a gemstone.

## Auxiliary Workflows

- **Bulk Import**: Covers fast inserts for subset of fields (serial, type/color/cut/clarity, weight & dimensions, price, stock flags, description, marketing highlights). Omits quantity, metadata_status, AI flags, media, certifications.
- **Inventory Management**: Only toggles `in_stock` and `delivery_days`; no quantity tracking, threshold logic, or audit storage beyond logs.
- **Pricing Management**: Updates price fields via service-role client imported in a client component (`"use client"`), leaving sensitive credentials exposed and failing when `supabaseAdmin` is `null` client-side.
- **Deletion**: `GemstoneAdminService.deleteGemstone` removes the gemstone row only. Related `gemstone_images`, `gemstone_videos`, `gemstones_ai_v6`, `certifications`, and storage assets are not cleaned up, leading to orphan data unless database-level cascades exist (none defined in migrations).

## Testing & Safeguards Snapshot

- Only test touching gemstones is `use-gemstone-query` unit test (catalog-facing). No Vitest or Playwright coverage for admin create/update/delete, media, import, or AI workflows.
- RLS relies on user_profiles `role = 'admin'`, but create/update actions occur through the browser Supabase anon client. Policies granting inserts/updates to admins are not present in repository migrations, making production behavior dependent on manual Supabase configuration.
- Multiple client-side services (`MediaUploadService`, `PriceManagementService`) instantiate service-role clients, leaking privileged operations to the browser. This violates security guidance and bypasses Row Level Security entirely.

**Overall**: Core gemstone attributes (identity, pricing, stock flags, descriptive text) have create/update coverage. Advanced metadata, moderation, AI review, quantity tracking, certification management, and cleanup workflows are absent, leaving CRUD incomplete for holistic gemstone product management.
